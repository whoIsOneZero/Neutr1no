import os
import vulners
from dotenv import load_dotenv

load_dotenv()
VULNERS_API_KEY = os.getenv("VULNERS_API_KEY")


def vulnerability_scan(services):
    vulners_api = vulners.VulnersApi(api_key=VULNERS_API_KEY)
    all_vulnerabilities = []

    for service in services:
        print(f"\n\nVulnerabilities found for service: {service}\n\n")
        try:
            results = vulners_api.find_exploit_all(service)
            filtered_results = [
                result for result in results if service in result['description']]

            if filtered_results:
                for result in filtered_results:
                    vulnerability = {
                        "CVE ID": result.get('id'),
                        "Title": result.get('title'),
                        "Description": result.get('description'),
                        "CVSS Score": result.get('cvss', {}).get('score', 'N/A')
                    }
                    all_vulnerabilities.append(vulnerability)
                    print(f"[+] CVE ID: {result.get('id')}")
                    print(f"- Title: {result.get('title')}")
                    print(f"- Description: {result.get('description')}")
                    print(
                        f"- CVSS Score: {vulnerability.get('CVSS Score', 'N/A')}")
            else:
                print(f"No vulnerabilities found for {service}")
        except Exception as e:
            print(
                f"Error searching for vulnerabilities for service {service}: {e}")

    return all_vulnerabilities
